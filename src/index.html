<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ryutsu 0.1</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #f7f8fa;
            color: #23272f;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 30px 0;
            margin-bottom: 30px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            background: none;
            color: #23272f;
            text-shadow: none;
        }
        
        header p {
            font-size: 1.2rem;
            color: #6b7280;
            max-width: 700px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .input-section {
            background: #fff;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.07);
            border: 1px solid #e5e7eb;
        }
        
        .input-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .input-group {
            flex: 1;
            min-width: 300px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #6366f1;
            font-size: 1.1rem;
        }
        
        .input-group select, .input-group input {
            width: 100%;
            padding: 14px;
            border-radius: 8px;
            border: 2px solid #d1d5db;
            background: #f3f4f6;
            color: #23272f;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .input-group textarea {
            width: 100%;
            height: 200px;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #d1d5db;
            background: #f3f4f6;
            color: #23272f;
            font-size: 1rem;
            resize: vertical;
            transition: all 0.3s ease;
        }
        
        .input-group textarea:focus, 
        .input-group select:focus, 
        .input-group input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 14px 28px;
            border-radius: 8px;
            border: none;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(to right, #6366f1, #818cf8);
            color: white;
            flex: 1;
        }
        
        .btn-secondary {
            background: linear-gradient(to right, #6ee7b7, #34d399);
            color: #23272f;
            flex: 1;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(99, 102, 241, 0.08);
        }
        
        .btn:active:not(:disabled) {
            transform: translateY(1px);
        }
        
        .results-section {
            background: #fff;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.07);
            border: 1px solid #e5e7eb;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .results-header h2 {
            font-size: 1.8rem;
            color: #6366f1;
        }
        
        .results-info {
            color: #6b7280;
            font-size: 1.1rem;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: #f9fafb;
            border-radius: 10px;
            overflow: hidden;
        }
        
        th {
            background: #f3f4f6;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #6366f1;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        tr:hover {
            background: #f1f5f9;
        }
        
        .item-name {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .item-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #6366f1, #818cf8);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #fff;
        }
        
        .quantity-cell {
            text-align: center;
        }
        
        .server-cell {
            text-align: center;
        }
        
        .price-cell {
            text-align: right;
            font-weight: 600;
            color: #f59e42;
        }
        
        .path-section {
            margin-top: 30px;
            background: #fff;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.07);
            border: 1px solid #e5e7eb;
        }
        
        .path-header {
            margin-bottom: 20px;
        }
        
        .path-header h2 {
            font-size: 1.8rem;
            color: #6366f1;
            margin-bottom: 10px;
        }
        
        .path-steps {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .path-step {
            background: #f3f4f6;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #6366f1;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .step-content {
            flex: 1;
        }
        
        .step-server {
            font-weight: 600;
            color: #34d399;
        }
        
        .step-items {
            color: #6b7280;
            margin-top: 5px;
            font-size: 0.9rem;
        }
        
        .step-price {
            font-weight: 600;
            color: #f59e42;
        }
        
        .step-savings {
            color: #34d399;
            font-weight: 600;
        }
        
        .total-row {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
        }
        
        .savings-row {
            color: #34d399;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
        }
        
        .error-section {
            background: #fef2f2;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid #fecaca;
            color: #b91c1c;
        }
        
        .success-section {
            background: #ecfdf5;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid #a7f3d0;
            color: #065f46;
        }
        
        .example-section {
            background: #f3f4f6;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid #d1d5db;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #9ca3af;
            font-size: 0.9rem;
            border-top: 1px solid #e5e7eb;
        }
        
        .copy-hint {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            color: #6b7280;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .input-row {
                flex-direction: column;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            header h1 {
                font-size: 2.2rem;
            }
            
            th, td {
                padding: 10px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-shopping-basket"></i> Ryutsu</h1>
            <p>Simplify server hopping between servers by pasting your items list and saving time.</p>
        </header>
        
        <section class="input-section">
            <div class="input-group">
                <label for="items-input"><i class="fas fa-clipboard-list"></i> Paste your items list</label>
                <div class="copy-hint">
                    <i class="fas fa-lightbulb"></i> In Teamcraft, click the "Copy to text" button to copy your items
                </div>
                <textarea id="items-input" placeholder="Paste your items here. Example:
4x Claro Walnut Lumber
1x Titanium Gold Nugget
5x Ra'Kaznar Ingot"></textarea>
            </div>
            
            <div class="input-row">
                <div class="input-group">
                    <label for="datacenter"><i class="fas fa-server"></i> Data Center</label>
                    <select id="datacenter">
                        <option value="" selected>-- Select Data Center --</option>
                        <option value="Aether">Aether (NA)</option>
                        <option value="Primal">Primal (NA)</option>
                        <option value="Crystal">Crystal (NA)</option>
                        <option value="Dynamis">Dynamis (NA)</option>
                        <option value="Chaos">Chaos (EU)</option>
                        <option value="Light">Light (EU)</option>
                        <option value="Materia">Materia (OCE)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="hq-switch"><i class="fas fa-gem"></i> Item Quality</label>
                    <div style="display: flex; align-items: center; gap: 12px; margin-top: 4px;">
                        <button id="nq-btn" type="button" class="btn btn-secondary" style="padding: 8px 18px; min-width: 60px;">NQ</button>
                        <button id="hq-btn" type="button" class="btn btn-secondary" style="padding: 8px 18px; min-width: 60px;">HQ</button>
                    </div>
                </div>
            </div>
            
            <div class="button-group">
                <button id="search-btn" class="btn btn-primary">
                    <i class="fas fa-search"></i> Search Prices
                </button>
                <button id="path-btn" class="btn btn-secondary" disabled>
                    <i class="fas fa-route"></i> Find Optimal Path
                </button>
            </div>
            
            <div class="success-section" id="success-section" style="display: none;"></div>
            
            <div class="example-section">
                <h3><i class="fas fa-info-circle"></i> Format Example</h3>
                <p>You can paste items in any of these formats:</p>
                <pre style="margin-top: 10px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px;">
4x Claro Walnut Lumber
1x Titanium Gold Nugget
5x Ra'Kaznar Ingot

- 10 Hoptrap Leaf
- 15 Clary Sage

8 × Effervescent Water</pre>
                <p>The app will automatically detect quantities and item names.</p>
            </div>
        </section>
        
        <section class="results-section">
            <div class="results-header">
                <h2><i class="fas fa-list"></i> Shopping List</h2>
                <div class="results-info" id="results-info">Enter your items and click Search Prices</div>
            </div>
            
            <div class="error-section" id="error-section" style="display: none;"></div>
            
            <div class="table-container">
                <table id="results-table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th class="quantity-cell">Quantity</th>
                            <th class="server-cell">Server</th>
                            <th class="price-cell">Lowest Price</th>
                        </tr>
                    </thead>
                    <tbody id="results-body">
                        <!-- Results will be populated here -->
                    </tbody>
                </table>
            </div>
        </section>
        
        <section class="path-section" id="path-section" style="display: none;">
            <div class="path-header">
                <h2><i class="fas fa-route"></i> Optimal Shopping Path</h2>
                <p>Follow this route to minimize travel and maximize savings</p>
            </div>
            
            <div class="path-steps" id="path-steps">
                <!-- Path steps will be added here -->
            </div>
            
            <div class="total-row" id="total-cost">
                Total Estimated Cost: 0 Gil
            </div>
            <div class="savings-row" id="total-savings">
                Estimated Savings: 0 Gil
            </div>
        </section>
        
        <footer>
            <p>
                Ryutsu v0.1 • Not Associated with Square Enix<br>
                Prices from <a href="https://universalis.app/" class="external-link">Universalis.app</a> • Item data from <a href="https://xivapi.com/" class="external-link">XIVAPI</a>
            </p>
            <p>
                Made by <a href="https://github.com/Jukehere" class="external-link">Juke</a>
            </p>
        </footer>
    </div>

    <script>
        // DOM elements
        const itemsInput = document.getElementById('items-input');
        const datacenterSelect = document.getElementById('datacenter');
        // const homeServerInput = document.getElementById('home-server');
        const searchBtn = document.getElementById('search-btn');
        const pathBtn = document.getElementById('path-btn');
        const resultsInfo = document.getElementById('results-info');
        const resultsBody = document.getElementById('results-body');
        const pathSection = document.getElementById('path-section');
        const pathSteps = document.getElementById('path-steps');
        const totalCost = document.getElementById('total-cost');
        const totalSavings = document.getElementById('total-savings');
        const errorSection = document.getElementById('error-section');
        const successSection = document.getElementById('success-section');
        
        // Store fetched data
        let shoppingList = [];
        let originalHomeServerPrices = {};
        let itemIdCache = {};
        let itemIconCache = {}; // Add icon cache
        
        // API endpoints
        const XIVAPI_SEARCH = 'https://v2.xivapi.com/api/search';
        const UNIVERSALIS_API = 'https://universalis.app/api/v2';
        
        // Function to parse items from text
        function parseItems(text) {
            const lines = text.split('\n');
            const items = [];
            
            const itemPattern = /(\d+)\s*[x×]\s*(.+)|-\s*(\d+)\s*(.+)|(\d+)\s+(.+)/i;
            
            for (const line of lines) {
                if (!line.trim()) continue;
                
                const match = line.match(itemPattern);
                
                if (match) {
                    let quantity, name;
                    
                    // Handle different formats
                    if (match[1] && match[2]) {
                        quantity = parseInt(match[1]);
                        name = match[2].trim();
                    } else if (match[3] && match[4]) {
                        quantity = parseInt(match[3]);
                        name = match[4].trim();
                    } else if (match[5] && match[6]) {
                        quantity = parseInt(match[5]);
                        name = match[6].trim();
                    } else {
                        continue;
                    }
                    
                    items.push({
                        name: name,
                        quantity: quantity
                    });
                }
            }
            
            return items;
        }
        
        // Function to fetch item ID and icon from XIVAPI v2
        async function fetchItemIdAndIconFromXIVAPI(itemName) {
            try {
                const cacheKey = itemName.toLowerCase();
                if (itemIdCache[cacheKey] && itemIconCache[cacheKey]) {
                    return { id: itemIdCache[cacheKey], icon: itemIconCache[cacheKey] };
                }

                const url = `${XIVAPI_SEARCH}?query=Name~"${encodeURIComponent(itemName)}"&sheets=Item&limit=1`;
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`XIVAPI error: ${response.status}`);
                }

                const data = await response.json();

                if (data.results && data.results.length > 0) {
                    const itemId = data.results[0].row_id;
                    let iconPath = null;
                    if (data.results[0].fields && data.results[0].fields.Icon) {
                        if (data.results[0].fields.Icon.path_hr1) {
                            // Remove .tex, remove ui/icon/, add .png
                            iconPath = data.results[0].fields.Icon.path_hr1
                                .replace(/^ui\/icon\//i, '')
                                .replace(/\.tex$/i, '.png');
                        } else if (data.results[0].fields.Icon.path) {
                            iconPath = data.results[0].fields.Icon.path
                                .replace(/^ui\/icon\//i, '')
                                .replace(/\.tex$/i, '.png');
                        }
                    }
                    const iconUrl = iconPath ? `https://xivapi.com/i/${iconPath}` : null;
                    itemIdCache[cacheKey] = itemId;
                    itemIconCache[cacheKey] = iconUrl;
                    return { id: itemId, icon: iconUrl };
                }
                return { id: null, icon: null };
            } catch (error) {
                console.error('XIVAPI fetch error:', error);
                return { id: null, icon: null };
            }
        }
        
        // Function to fetch market data from Universalis
        async function fetchMarketData(dataCenter, items) {
            try {
                // Filter items with valid IDs
                const validItems = items.filter(item => item.itemId !== null && !item.error);
                
                if (validItems.length === 0) {
                    throw new Error('No items with valid IDs found');
                }
                
                // Extract item IDs
                const itemIds = validItems.map(item => item.itemId);
                
                // Build API URL
                const url = `${UNIVERSALIS_API}/${dataCenter}/${itemIds.join(',')}?listings=50`;
                
                // Fetch data
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Universalis API error: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Market data error:', error);
                throw new Error('Failed to fetch market data. Please try again later.');
            }
        }
        
        // HQ/NQ switch logic
        let isHQ = false;
        const nqBtn = document.getElementById('nq-btn');
        const hqBtn = document.getElementById('hq-btn');
        function updateQualityButtons() {
            if (isHQ) {
                hqBtn.classList.add('btn-primary');
                hqBtn.classList.remove('btn-secondary');
                nqBtn.classList.remove('btn-primary');
                nqBtn.classList.add('btn-secondary');
            } else {
                nqBtn.classList.add('btn-primary');
                nqBtn.classList.remove('btn-secondary');
                hqBtn.classList.remove('btn-primary');
                hqBtn.classList.add('btn-secondary');
            }
        }
        nqBtn.addEventListener('click', () => {
            isHQ = false;
            updateQualityButtons();
        });
        hqBtn.addEventListener('click', () => {
            isHQ = true;
            updateQualityButtons();
        });
        updateQualityButtons();
        
        // Function to find best server for each item
        function findBestServers(marketData, items, homeServer) {
            return items.map(item => {
                // Handle items with errors
                if (item.error || !item.itemId) {
                    return {
                        ...item,
                        server: 'N/A',
                        price: 0,
                        homePrice: 0,
                        error: item.error || 'Invalid item ID'
                    };
                }
                
                const itemId = item.itemId;
                const itemData = marketData.items[itemId];

                if (!itemData || !itemData.listings || itemData.listings.length === 0) {
                    return {
                        ...item,
                        server: 'N/A',
                        price: 0,
                        homePrice: 0,
                        hq: false,
                        error: 'No market data available'
                    };
                }

                // Filter listings by HQ/NQ
                const filteredListings = itemData.listings.filter(l => !!l.hq === isHQ);

                // If no HQ listings, fallback to NQ price and mark as fallback
                if (isHQ && filteredListings.length === 0) {
                    // Try to get NQ listing
                    const nqListings = itemData.listings.filter(l => !l.hq);
                    if (nqListings.length > 0) {
                        // Find the best NQ listing (lowest price)
                        let bestNQ = nqListings[0];
                        for (const listing of nqListings) {
                            if (listing.pricePerUnit < bestNQ.pricePerUnit) {
                                bestNQ = listing;
                            }
                        }
                        return {
                            ...item,
                            server: bestNQ.worldName,
                            price: bestNQ.pricePerUnit,
                            homePrice: 0,
                            hq: false,
                            error: undefined, // No error, show as NQ
                            fallbackToNQ: true // Mark as fallback for UI
                        };
                    } else {
                        return {
                            ...item,
                            server: 'N/A',
                            price: 0,
                            homePrice: 0,
                            hq: false,
                            error: 'No HQ or NQ listings available'
                        };
                    }
                }

                // If no NQ listings (when NQ is selected)
                if (!isHQ && filteredListings.length === 0) {
                    return {
                        ...item,
                        server: 'N/A',
                        price: 0,
                        homePrice: 0,
                        hq: false,
                        error: 'No NQ listings available'
                    };
                }

                // Find the best listing (lowest price)
                let bestListing = filteredListings[0];
                for (const listing of filteredListings) {
                    if (listing.pricePerUnit < bestListing.pricePerUnit) {
                        bestListing = listing;
                    }
                }

                originalHomeServerPrices[itemId] = 0;

                return {
                    ...item,
                    server: bestListing.worldName,
                    price: bestListing.pricePerUnit,
                    homePrice: 0,
                    hq: !!bestListing.hq,
                    error: undefined,
                    fallbackToNQ: false
                };
            });
        }
        
        // Function to generate item rows
        function generateItemRows(items) {
            resultsBody.innerHTML = '';

            items.forEach(item => {
                const row = document.createElement('tr');

                // Handle errors
                if (item.error) {
                    row.innerHTML = `
                        <td colspan="4">
                            <div class="item-name">
                                <div class="item-icon" style="background: rgba(231, 76, 60, 0.3);">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <div>
                                    <div>
                                        ${item.hq ? `<img src="https://xivapi.com/img-misc/hq.png" alt="HQ" title="HQ" style="width:16px;height:16px;vertical-align:middle;margin-right:6px;"/>` : ''}
                                        ${item.name}
                                    </div>
                                    <div style="color: #e74c3c; font-size: 0.9rem; margin-top: 5px;">
                                        <i class="fas fa-exclamation-circle"></i> ${item.error}
                                    </div>
                                </div>
                            </div>
                        </td>
                    `;
                    resultsBody.appendChild(row);
                    return;
                }
                // Create item icon and HQ badge
                const hqIcon = item.hq
                    ? `<img src="https://xivapi.com/img-misc/hq.png" alt="HQ" title="HQ" style="width:16px;height:16px;vertical-align:middle;margin-right:6px;"/>`
                    : '';

                // Item icon (fallback to cube if missing)
                const itemIcon = item.icon
                    ? `<img src="${item.icon}" alt="" style="width:40px;height:40px;border-radius:6px;object-fit:cover;background:#fff;"/>`
                    : `<i class="fas fa-cube"></i>`;

                row.innerHTML = `
                    <td>
                        <div class="item-name">
                            <div class="item-icon">
                                ${itemIcon}
                            </div>
                            <div>
                                <div>
                                    ${hqIcon}${item.name}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="quantity-cell">${item.quantity}</td>
                    <td class="server-cell">${item.server}</td>
                    <td class="price-cell">${item.price.toLocaleString()} Gil</td>
                `;

                resultsBody.appendChild(row);
            });
        }
        
        // Function to generate optimal path
        function generateOptimalPath(items) {
            pathSteps.innerHTML = '';

            // Remove any previous map
            const oldMap = document.getElementById('path-map');
            if (oldMap) oldMap.remove();

            // Group items by server
            const itemsByServer = {};
            let totalCostValue = 0;
            let homeServerCost = 0;

            items.forEach(item => {
                if (item.server === 'N/A' || item.error) return;

                if (!itemsByServer[item.server]) {
                    itemsByServer[item.server] = [];
                }
                itemsByServer[item.server].push(item);

                // Calculate total cost
                totalCostValue += item.price * item.quantity;

                // Calculate what it would cost on home server
                if (originalHomeServerPrices[item.itemId]) {
                    homeServerCost += originalHomeServerPrices[item.itemId] * item.quantity;
                }
            });

            // Create server steps
            let stepCount = 1;
            const serverList = Object.keys(itemsByServer);

            serverList.forEach(server => {
                const step = document.createElement('div');
                step.className = 'path-step';

                const serverItems = itemsByServer[server];
                const serverCost = serverItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const itemsList = serverItems.slice(0, 3).map(item => `${item.quantity}x ${item.name}`).join(', ');
                const extraItems = serverItems.length > 3 ? ` +${serverItems.length - 3} more` : '';
                
                step.innerHTML = `
                    <div class="step-number">${stepCount}</div>
                    <div class="step-content">
                        <div>Travel to <span class="step-server">${server}</span></div>
                        <div class="step-items">${itemsList}${extraItems}</div>
                    </div>
                    <div class="step-price">${serverCost.toLocaleString()} Gil</div>
                `;
                
                pathSteps.appendChild(step);
                stepCount++;
            });

            // Calculate and display savings
            const savings = homeServerCost - totalCostValue;
            const savingsText = savings > 0 ?
                `Estimated Savings: ${savings.toLocaleString()} Gil` :
                'No savings estimated (home server prices unavailable)';

            totalCost.textContent = `Total Estimated Cost: ${totalCostValue.toLocaleString()} Gil`;
            totalSavings.textContent = savingsText;
            totalSavings.style.display = savings > 0 ? 'flex' : 'none';

            // --- MAP RENDERING ---
            // Show a simple "map" of the path as a row of server names with arrows at the bottom
            if (serverList.length > 1) {
                const mapDiv = document.createElement('div');
                mapDiv.id = 'path-map';
                mapDiv.style.margin = '32px 0 24px 0';
                mapDiv.style.display = 'flex';
                mapDiv.style.alignItems = 'center';
                mapDiv.style.justifyContent = 'center';
                mapDiv.style.gap = '18px';
                mapDiv.style.fontWeight = 'bold';
                mapDiv.style.fontSize = '1.1rem';
                mapDiv.style.flexWrap = 'wrap'; // Allow wrapping on small screens
                mapDiv.style.overflowX = 'auto'; // Allow horizontal scroll if needed
                mapDiv.style.maxWidth = '100%';
                mapDiv.style.boxSizing = 'border-box';

                serverList.forEach((server, idx) => {
                    const serverSpan = document.createElement('span');
                    serverSpan.textContent = server;
                    serverSpan.style.padding = '8px 20px';
                    serverSpan.style.background = '#f3f4f6';
                    serverSpan.style.borderRadius = '6px';
                    serverSpan.style.border = '1px solid #e5e7eb';
                    serverSpan.style.color = '#6366f1';
                    serverSpan.style.wordBreak = 'break-word';
                    mapDiv.appendChild(serverSpan);

                    if (idx < serverList.length - 1) {
                        const arrow = document.createElement('span');
                        arrow.innerHTML = '<i class="fas fa-arrow-right"></i>';
                        arrow.style.color = '#9ca3af';
                        mapDiv.appendChild(arrow);
                    }
                });

                // Wrap in a container for overflow on mobile
                const mapContainer = document.createElement('div');
                mapContainer.style.overflowX = 'auto';
                mapContainer.style.width = '100%';
                mapContainer.style.boxSizing = 'border-box';
                mapContainer.appendChild(mapDiv);

                // Insert after pathSteps (at the bottom of the section)
                pathSection.appendChild(mapContainer);
            }

            // Show path section
            pathSection.style.display = 'block';
        }
        
        // Function to show error message
        function showError(message) {
            errorSection.style.display = 'block';
            errorSection.innerHTML = `
                <h3><i class="fas fa-exclamation-triangle"></i> Error</h3>
                <p>${message}</p>
            `;
        }
        
        // Function to show success message
        function showSuccess(message) {
            successSection.style.display = 'block';
            successSection.innerHTML = `
                <h3><i class="fas fa-check-circle"></i> Success</h3>
                <p>${message}</p>
            `;
        }
        
        // Function to hide messages
        function hideMessages() {
            errorSection.style.display = 'none';
            successSection.style.display = 'none';
        }
        
        // Event listeners
        searchBtn.addEventListener('click', async function() {
            const itemsText = itemsInput.value;
            const dc = datacenterSelect.value;
            // const homeServer = homeServerInput.value.trim();

            if (!itemsText) {
                showError('Please enter your items list');
                return;
            }

            if (!dc) {
                showError('Please select a data center');
                return;
            }

            // Show loading state
            searchBtn.disabled = true;
            searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Searching...';
            pathBtn.disabled = true;
            resultsInfo.textContent = 'Parsing items...';
            resultsBody.innerHTML = '';
            pathSection.style.display = 'none';
            hideMessages();
            
            try {
                // Parse items from text
                const parsedItems = parseItems(itemsText);
                
                if (parsedItems.length === 0) {
                    throw new Error('No valid items found. Please check your format.');
                }
                
                // Show how many items were parsed
                resultsInfo.textContent = `Found ${parsedItems.length} items. Fetching item IDs...`;
                
                // Fetch item IDs and icons from XIVAPI
                const itemsWithIds = [];
                for (const item of parsedItems) {
                    const { id: itemId, icon } = await fetchItemIdAndIconFromXIVAPI(item.name);
                    if (itemId) {
                        itemsWithIds.push({ ...item, itemId, icon });
                    } else {
                        itemsWithIds.push({ ...item, itemId: null, icon: null, error: 'Item not found in XIVAPI' });
                    }
                }
                
                // Show progress
                const validItems = itemsWithIds.filter(item => item.itemId && !item.error).length;
                resultsInfo.textContent = `Fetched IDs for ${validItems} items. Getting market data...`;
                
                if (validItems < itemsWithIds.length) {
                    resultsInfo.textContent += ` (${itemsWithIds.length - validItems} items had issues)`;
                }
                
                // Fetch market data
                const marketData = await fetchMarketData(dc, itemsWithIds);

                // Show success message
                showSuccess(`Fetched real-time market data from ${dc} data center`);

                // Process market data to find best servers
                shoppingList = findBestServers(marketData, itemsWithIds, /*homeServer*/ null);

                // Update UI
                const validMarketItems = shoppingList.filter(item => !item.error).length;
                resultsInfo.textContent = `${validMarketItems} items with prices found on ${dc} Data Center`;
                
                if (validMarketItems < shoppingList.length) {
                    resultsInfo.textContent += ` (${shoppingList.length - validMarketItems} items had issues)`;
                }
                
                generateItemRows(shoppingList);
                
                // Enable path button
                pathBtn.disabled = false;
                
            } catch (error) {
                console.error('Error:', error);
                resultsInfo.textContent = 'Error processing data. See details below.';
                showError(error.message || 'An unexpected error occurred. Please try again.');
            } finally {
                // Reset button
                searchBtn.disabled = false;
                searchBtn.innerHTML = '<i class="fas fa-search"></i> Search Prices';
            }
        });
        
        pathBtn.addEventListener('click', function() {
            if (shoppingList.length === 0) {
                showError('No shopping list data available');
                return;
            }
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculating...';
            hideMessages();
            setTimeout(() => {
                generateOptimalPath(shoppingList);
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-route"></i> Find Optimal Path';
            }, 500);
        });

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('a.external-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const url = this.href;
                    if (window.require) {
                        const { shell } = window.require('electron');
                        shell.openExternal(url);
                    } else {
                        window.open(url, '_blank', 'noopener');
                    }
                });
            });
        });

        window.addEventListener('DOMContentLoaded', () => {
            itemsInput.value = '';
        });
    </script>
</body>
</html>