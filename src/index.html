<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ryutsu 0.21</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", system-ui, sans-serif;
      }

      body {
        background: #f8f9fa;
        color: #1a1d28;
        min-height: 100vh;
        padding: 0;
        transition: background 0.3s, color 0.3s;
      }

      body.dark-mode {
        background: #000;
        color: #e4e6eb;
      }

      .top-menu {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 20px;
        background: #ffffff;
        border-bottom: 1px solid #eaeaea;
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      body.dark-mode .top-menu {
        background: #000;
        border-bottom: 1px solid #222;
      }

      .app-title {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 1.2rem;
        font-weight: 600;
        color: #6366f1;
      }

      body.dark-mode .app-title {
        color: #a5b4fc;
      }

      .app-title i {
        font-size: 1.3rem;
      }

      .menu-controls {
        display: flex;
        gap: 15px;
      }

      .menu-btn {
        background: none;
        border: none;
        color: #5c5f77;
        font-size: 1.1rem;
        cursor: pointer;
        padding: 6px 10px;
        border-radius: 6px;
        transition: all 0.2s;
      }

      .menu-btn:hover {
        background: #f3f4f6;
      }

      body.dark-mode .menu-btn {
        color: #a1a1aa;
      }

      body.dark-mode .menu-btn:hover {
        background: #111;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .input-section {
        background: #ffffff;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        border: 1px solid #eaeaea;
      }

      body.dark-mode .input-section {
        background: #000;
        border: 1px solid #222;
      }

      .input-group {
        margin-bottom: 18px;
      }

      .input-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #6366f1;
        font-size: 0.95rem;
      }

      body.dark-mode .input-group label {
        color: #a5b4fc;
      }

      .input-group textarea {
        width: 100%;
        height: 150px;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        background: #f8fafc;
        color: #1a1d28;
        font-size: 0.95rem;
        resize: vertical;
        transition: all 0.3s ease;
      }

      body.dark-mode .input-group textarea {
        background: #000;
        border-color: #222;
        color: #e4e6eb;
      }

      .input-group textarea:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.15);
      }

      body.dark-mode .input-group textarea:focus {
        border-color: #818cf8;
        box-shadow: 0 0 0 2px rgba(129, 140, 248, 0.25);
      }

      .input-row {
        display: flex;
        gap: 15px;
        margin-bottom: 18px;
        flex-wrap: wrap;
      }

      .input-row > * {
        flex: 1;
        min-width: 200px;
      }

      .input-group select,
      .input-group input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        background: #f8fafc;
        color: #1a1d28;
        font-size: 0.95rem;
        transition: all 0.3s ease;
      }

      body.dark-mode .input-group select,
      body.dark-mode .input-group input {
        background: #000;
        border-color: #222;
        color: #e4e6eb;
      }

      .input-group select:focus,
      .input-group input:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.15);
      }

      body.dark-mode .input-group select:focus,
      body.dark-mode .input-group input:focus {
        border-color: #818cf8;
        box-shadow: 0 0 0 2px rgba(129, 140, 248, 0.25);
      }

      .quality-toggle {
        display: flex;
        gap: 10px;
        margin-top: 4px;
      }

      .quality-btn {
        flex: 1;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        background: #f8fafc;
        color: #4b5563;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      body.dark-mode .quality-btn {
        background: #000;
        border-color: #222;
        color: #a1a1aa;
      }

      .quality-btn.active {
        background: #eef2ff;
        border-color: #c7d2fe;
        color: #6366f1;
      }

      body.dark-mode .quality-btn.active {
        background: #000;
        border-color: #4338ca;
        color: #a5b4fc;
      }

      .button-group {
        display: flex;
        gap: 12px;
        margin-top: 10px;
      }

      .btn {
        padding: 12px 20px;
        border-radius: 8px;
        border: none;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        flex: 1;
      }

      .btn-primary {
        background: #6366f1;
        color: white;
      }

      .btn-primary:hover:not(:disabled) {
        background: #4f46e5;
      }

      .btn-secondary {
        background: #10b981;
        color: white;
      }

      .btn-secondary:hover:not(:disabled) {
        background: #059669;
      }

      .btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }

      .results-section {
        background: #ffffff;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        border: 1px solid #eaeaea;
      }

      body.dark-mode .results-section {
        background: #000;
        border: 1px solid #222;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 18px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eaeaea;
      }

      body.dark-mode .section-header {
        border-bottom: 1px solid #222;
      }

      .section-header h2 {
        font-size: 1.3rem;
        color: #6366f1;
      }

      body.dark-mode .section-header h2 {
        color: #a5b4fc;
      }

      .results-info {
        color: #6b7280;
        font-size: 0.9rem;
      }

      body.dark-mode .results-info {
        color: #9ca3af;
      }

      .table-container {
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.92rem;
      }

      th {
        background: #f3f4f6;
        padding: 12px 15px;
        text-align: left;
        font-weight: 600;
        color: #6366f1;
      }

      body.dark-mode th {
        background: #000;
        color: #a5b4fc;
      }

      td {
        padding: 12px 15px;
        border-bottom: 1px solid #eaeaea;
      }

      body.dark-mode td {
        border-bottom: 1px solid #222;
      }

      tr:last-child td {
        border-bottom: none;
      }

      tr:hover {
        background: #f8fafc;
      }

      body.dark-mode tr:hover {
        background: #111;
      }

      .item-name {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .item-icon {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        background: #eef2ff;
        color: #6366f1;
      }

      body.dark-mode .item-icon {
        background: #000;
        color: #a5b4fc;
      }

      .quantity-cell {
        text-align: center;
      }

      .server-cell {
        text-align: center;
      }

      .price-cell {
        text-align: right;
        font-weight: 600;
        color: #f59e0b;
      }

      body.dark-mode .price-cell {
        color: #fbbf24;
      }

      /* Path Section */
      .path-section {
        background: #ffffff;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        border: 1px solid #eaeaea;
        margin-bottom: 25px;
      }

      body.dark-mode .path-section {
        background: #000;
        border: 1px solid #222;
      }

      .path-steps {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .path-step {
        background: #f8fafc;
        border-radius: 8px;
        padding: 15px;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      body.dark-mode .path-step {
        background: #000;
      }

      .step-number {
        width: 26px;
        height: 26px;
        border-radius: 50%;
        background: #6366f1;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.9rem;
      }

      body.dark-mode .step-number {
        background: #818cf8;
      }

      .step-content {
        flex: 1;
      }

      .step-server {
        font-weight: 600;
        color: #10b981;
      }

      body.dark-mode .step-server {
        color: #6ee7b7;
      }

      .step-items {
        color: #6b7280;
        margin-top: 4px;
        font-size: 0.85rem;
      }

      body.dark-mode .step-items {
        color: #9ca3af;
      }

      .step-price {
        font-weight: 600;
        color: #f59e0b;
      }

      body.dark-mode .step-price {
        color: #fbbf24;
      }

      .step-savings {
        color: #10b981;
        font-weight: 600;
      }

      body.dark-mode .step-savings {
        color: #6ee7b7;
      }

      .total-row {
        margin-top: 18px;
        padding-top: 15px;
        border-top: 1px solid #eaeaea;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
      }

      body.dark-mode .total-row {
        border-top: 1px solid #222;
      }

      .savings-row {
        color: #10b981;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        margin-top: 5px;
      }

      body.dark-mode .savings-row {
        color: #6ee7b7;
      }

      .message-section {
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
        display: none;
      }

      .error-section {
        background: #fef2f2;
        border: 1px solid #fecaca;
        color: #b91c1c;
      }

      body.dark-mode .error-section {
        background: #000;
        border-color: #b91c1c;
        color: #fecaca;
      }

      .success-section {
        background: #ecfdf5;
        border: 1px solid #a7f3d0;
        color: #065f46;
      }

      body.dark-mode .success-section {
        background: #000;
        border-color: #34d399;
        color: #a7f3d0;
      }

      .example-section {
        background: #f3f4f6;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
        border: 1px solid #d1d5db;
        font-size: 0.9rem;
      }

      body.dark-mode .example-section {
        background: #000;
        border-color: #222;
        color: #d4d4d8;
      }

      .example-section h3 {
        font-size: 1rem;
        margin-bottom: 8px;
        color: #4b5563;
      }

      body.dark-mode .example-section h3 {
        color: #9ca3af;
      }

      .example-section pre {
        background: rgba(0, 0, 0, 0.05);
        padding: 10px;
        border-radius: 6px;
        margin-top: 8px;
        font-size: 0.85rem;
        overflow-x: auto;
      }

      body.dark-mode .example-section pre {
        background: #000;
      }

      footer {
        text-align: center;
        margin-top: 30px;
        padding: 20px;
        color: #6b7280;
        font-size: 0.85rem;
        border-top: 1px solid #eaeaea;
      }

      body.dark-mode footer {
        color: #9ca3af;
        border-top: 1px solid #222;
      }

      footer a {
        color: #6366f1;
        text-decoration: none;
      }

      body.dark-mode footer a {
        color: #a5b4fc;
      }

      footer a:hover {
        text-decoration: underline;
      }

      @media (max-width: 768px) {
        .input-row {
          flex-direction: column;
        }

        .button-group {
          flex-direction: column;
        }

        .top-menu {
          padding: 10px 15px;
        }

        .app-title {
          font-size: 1.1rem;
        }

        .container {
          padding: 15px;
        }

        th,
        td {
          padding: 10px 12px;
        }
      }
    </style>
    <style>
      .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.35);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .modal-box {
        background: #fff;
        color: #222;
        border-radius: 12px;
        max-width: 420px;
        width: 90vw;
        padding: 28px 24px 20px 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.18);
        position: relative;
      }
      .modal-box h3 {
        margin-top: 0;
        margin-bottom: 10px;
        font-size: 1.15rem;
        color: #6366f1;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .modal-box .close-btn {
        position: absolute;
        top: 12px;
        right: 16px;
        background: none;
        border: none;
        font-size: 1.2rem;
        color: #888;
        cursor: pointer;
      }
      .modal-box pre {
        background: #f3f4f6;
        border-radius: 6px;
        padding: 10px;
        margin-top: 8px;
        font-size: 0.95rem;
        overflow-x: auto;
      }
      .modal-box p {
        margin-bottom: 0.5em;
      }
      body.dark-mode .modal-box {
        background: #000;
        color: #e4e6eb;
      }
      body.dark-mode .modal-box pre {
        background: #000;
      }
      body.dark-mode .modal-box h3 {
        color: #a5b4fc;
      }
    </style>
    <style>
      .route-items-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 6px;
        align-items: flex-start;
      }
      .route-item-icon {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border-radius: 7px;
        background: #eef2ff;
        cursor: pointer;
        transition: box-shadow 0.2s;
        outline: none;
        margin-bottom: 0;
      }
      .route-item-icon:focus {
        box-shadow: 0 0 0 2px #6366f1;
      }
      body.dark-mode .route-item-icon {
        background: #000;
      }
      .route-item-icon img,
      .route-item-icon i {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        display: block;
      }
      .route-tooltip {
        visibility: hidden;
        opacity: 0;
        width: max-content;
        background: #222;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 6px 10px;
        position: absolute;
        z-index: 10;
        bottom: 110%;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.92rem;
        pointer-events: none;
        transition: opacity 0.2s;
        white-space: nowrap;
        min-height: 0;
        line-height: 1.2;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .route-tooltip i {
        vertical-align: middle;
        display: inline-block;
        font-size: 1em;
        margin: 0;
      }
      .route-item-icon {
        vertical-align: middle;
      }
      .route-tooltip.copied {
        background: #10b981;
        color: #fff;
      }
      .route-item-icon:hover .route-tooltip,
      .route-item-icon:focus .route-tooltip {
        visibility: visible;
        opacity: 1;
      }
      .route-tooltip.copied {
        background: #10b981;
        color: #fff;
      }
    </style>
  </head>
  <body class="light-mode">
    <div class="top-menu">
      <div class="app-title">
        <i class="fas fa-shopping-basket"></i>
        <span>Ryutsu</span>
      </div>
      <div class="menu-controls">
        <button id="help-btn" class="menu-btn" title="Help">
          <i class="fas fa-question-circle"></i> Help
        </button>
        <a
          href="https://github.com/Jukehere/Ryutsu"
          target="_blank"
          class="menu-btn"
          title="GitHub"
          style="
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 1.25rem;
          "
        >
          <i class="fab fa-github"></i>
        </a>
        <button
          id="mode-toggle"
          class="menu-btn"
          title="Toggle dark/light mode"
        >
          <i class="fas fa-moon"></i>
        </button>
      </div>
    </div>

    <div class="container">
      <section class="input-section">
        <div class="input-group">
          <label for="items-input">
            <i class="fas fa-clipboard-list"></i> Paste your items list
          </label>
          <textarea
            id="items-input"
            placeholder="Paste your items here. Example:
4x Claro Walnut Lumber
1x Titanium Gold Nugget
5x Ra'Kaznar Ingot"
          ></textarea>
        </div>

        <div class="input-row">
          <div class="input-group">
            <label for="datacenter">
              <i class="fas fa-server"></i> Data Center
            </label>
            <select id="datacenter">
              <option value="" selected>-- Select Data Center --</option>
              <option value="Elemental">Elemental (JP)</option>
              <option value="Gaia">Gaia (JP)</option>
              <option value="Mana">Mana (JP)</option>
              <option value="Meteor">Meteor (JP)</option>
              <option value="Aether">Aether (NA)</option>
              <option value="Primal">Primal (NA)</option>
              <option value="Crystal">Crystal (NA)</option>
              <option value="Dynamis">Dynamis (NA)</option>
              <option value="Chaos">Chaos (EU)</option>
              <option value="Light">Light (EU)</option>
              <option value="Materia">Materia (OCE)</option>
            </select>
          </div>
          <div class="input-group">
            <label for="hq-switch">
              <i class="fas fa-gem"></i> Item Quality
            </label>
            <div class="quality-toggle">
              <button id="nq-btn" type="button" class="quality-btn active">
                NQ
              </button>
              <button id="hq-btn" type="button" class="quality-btn">HQ</button>
            </div>
          </div>
        </div>

        <div class="button-group">
          <button id="search-btn" class="btn btn-primary">
            <i class="fas fa-search"></i> Search Prices
          </button>
        </div>
        <div class="success-section message-section" id="success-section"></div>
        <div class="error-section message-section" id="error-section"></div>
      </section>

      <section class="results-section">
        <div class="section-header">
          <h2><i class="fas fa-list"></i> Shopping List</h2>
          <div class="results-info" id="results-info">
            Enter your items and click Search Prices
          </div>
        </div>

        <div class="table-container">
          <table id="results-table">
            <thead>
              <tr>
                <th>Item</th>
                <th class="quantity-cell">Qty</th>
                <th class="server-cell">Server</th>
                <th class="price-cell">Price</th>
              </tr>
            </thead>
            <tbody id="results-body"></tbody>
          </table>
        </div>
        <div class="button-group" id="path-btn-group" style="margin-top: 18px">
          <button id="path-btn" class="btn btn-secondary" disabled>
            <i class="fas fa-route"></i> Find Path
          </button>
        </div>
      </section>

      <section class="path-section" id="path-section" style="display: none">
        <div class="section-header">
          <h2><i class="fas fa-route"></i> Optimal Shopping Path</h2>
        </div>

        <div class="path-steps" id="path-steps"></div>

        <div class="total-row" id="total-cost">Total Estimated Cost: 0 Gil</div>
        <div class="savings-row" id="total-savings">
          Estimated Savings: 0 Gil
        </div>
      </section>

      <footer>
        <p>
          Ryutsu v0.2 • Not Associated with Square Enix<br />
          Prices from
          <a href="https://universalis.app/" target="_blank">Universalis.app</a>
          • Item data from
          <a href="https://xivapi.com/" target="_blank">XIVAPI</a>
        </p>
        <p>
          Made by <a href="https://github.com/Jukehere" target="_blank">Juke</a>
        </p>
      </footer>
    </div>

    <script>
      function showHelpModal() {
        if (document.getElementById("help-modal-backdrop")) return;
        const modal = document.createElement("div");
        modal.className = "modal-backdrop";
        modal.id = "help-modal-backdrop";
        modal.innerHTML = `
          <div class="modal-box">
            <button class="close-btn" id="close-help-modal" title="Close">&times;</button>
            <h3><i class="fas fa-info-circle"></i> Format Example</h3>
            <p>You can paste items in any of these formats:</p>
            <pre>
4x Claro Walnut Lumber
1x Titanium Gold Nugget
5x Ra'Kaznar Ingot

- 10 Hoptrap Leaf
- 15 Clary Sage

8 × Effervescent Water</pre>
            <p>The app will automatically detect quantities and item names.</p>
          </div>
        `;
        document.body.appendChild(modal);
        document.getElementById("close-help-modal").onclick = () => {
          modal.remove();
        };
        modal.onclick = (e) => {
          if (e.target === modal) modal.remove();
        };
      }

      const itemsInput = document.getElementById("items-input");
      const datacenterSelect = document.getElementById("datacenter");
      const searchBtn = document.getElementById("search-btn");
      const pathBtn = document.getElementById("path-btn");
      const resultsInfo = document.getElementById("results-info");
      const resultsBody = document.getElementById("results-body");
      const pathSection = document.getElementById("path-section");
      const pathSteps = document.getElementById("path-steps");
      const totalCost = document.getElementById("total-cost");
      const totalSavings = document.getElementById("total-savings");
      const errorSection = document.getElementById("error-section");
      const successSection = document.getElementById("success-section");
      let shoppingList = [];
      let originalHomeServerPrices = {};
      let itemIdCache = {};
      let itemIconCache = {};
      let canonicalNameCache = {};
      const XIVAPI_SEARCH = "https://v2.xivapi.com/api/search";
      const UNIVERSALIS_API = "https://universalis.app/api/v2";

      function parseItems(text) {
        const lines = text.split("\n");
        const items = [];
        const itemPattern =
          /(\d+)\s*[x×]\s*(.+)|-\s*(\d+)\s*(.+)|(\d+)\s+(.+)/i;
        for (const line of lines) {
          if (!line.trim()) continue;
          const match = line.match(itemPattern);
          if (match) {
            let quantity, name;
            if (match[1] && match[2]) {
              quantity = parseInt(match[1]);
              name = match[2].trim();
            } else if (match[3] && match[4]) {
              quantity = parseInt(match[3]);
              name = match[4].trim();
            } else if (match[5] && match[6]) {
              quantity = parseInt(match[5]);
              name = match[6].trim();
            } else {
              continue;
            }
            items.push({
              name: name,
              quantity: quantity,
            });
          }
        }
        return items;
      }

      async function fetchItemIdAndIconFromXIVAPI(itemName) {
        try {
          const cacheKey = itemName.toLowerCase();
          if (
            itemIdCache[cacheKey] &&
            itemIconCache[cacheKey] &&
            canonicalNameCache[cacheKey]
          ) {
            return {
              id: itemIdCache[cacheKey],
              icon: itemIconCache[cacheKey],
              canonicalName: canonicalNameCache[cacheKey],
            };
          }
          const url = `${XIVAPI_SEARCH}?query=Name~"${encodeURIComponent(
            itemName
          )}"&sheets=Item&limit=1`;
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(`XIVAPI error: ${response.status}`);
          }
          const data = await response.json();
          if (data.results && data.results.length > 0) {
            const itemId = data.results[0].row_id;
            let iconPath = null;
            let canonicalName =
              data.results[0].fields && data.results[0].fields.Name
                ? data.results[0].fields.Name
                : itemName;
            if (data.results[0].fields && data.results[0].fields.Icon) {
              if (data.results[0].fields.Icon.path_hr1) {
                iconPath = data.results[0].fields.Icon.path_hr1
                  .replace(/^ui\/icon\//i, "")
                  .replace(/\.tex$/i, ".png");
              } else if (data.results[0].fields.Icon.path) {
                iconPath = data.results[0].fields.Icon.path
                  .replace(/^ui\/icon\//i, "")
                  .replace(/\.tex$/i, ".png");
              }
            }
            const iconUrl = iconPath
              ? `https://xivapi.com/i/${iconPath}`
              : null;
            itemIdCache[cacheKey] = itemId;
            itemIconCache[cacheKey] = iconUrl;
            canonicalNameCache[cacheKey] = canonicalName;
            return { id: itemId, icon: iconUrl, canonicalName };
          }
          return { id: null, icon: null, canonicalName: itemName };
        } catch (error) {
          console.error("XIVAPI fetch error:", error);
          return { id: null, icon: null, canonicalName: itemName };
        }
      }

      async function fetchMarketData(dataCenter, items) {
        try {
          const validItems = items.filter(
            (item) => item.itemId !== null && !item.error
          );
          if (validItems.length === 0) {
            throw new Error("No items with valid IDs found");
          }
          const itemIds = validItems.map((item) => item.itemId);
          const url = `${UNIVERSALIS_API}/${dataCenter}/${itemIds.join(
            ","
          )}?listings=50`;
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(`Universalis API error: ${response.status}`);
          }
          const data = await response.json();
          if (!Array.isArray(itemIds) || itemIds.length === 1) {
            if (!data.items) {
              return { items: { [itemIds[0]]: data } };
            }
          }
          return data;
        } catch (error) {
          console.error("Market data error:", error);
          throw new Error(
            "Failed to fetch market data. Please try again later."
          );
        }
      }

      let isHQ = false;
      const nqBtn = document.getElementById("nq-btn");
      const hqBtn = document.getElementById("hq-btn");

      function updateQualityButtons() {
        if (isHQ) {
          hqBtn.classList.add("active");
          nqBtn.classList.remove("active");
        } else {
          nqBtn.classList.add("active");
          hqBtn.classList.remove("active");
        }
      }

      nqBtn.addEventListener("click", () => {
        isHQ = false;
        updateQualityButtons();
      });

      hqBtn.addEventListener("click", () => {
        isHQ = true;
        updateQualityButtons();
      });

      updateQualityButtons();

      function findBestServers(marketData, items, homeServer) {
        return items.map((item) => {
          if (item.error || !item.itemId) {
            return {
              ...item,
              server: "N/A",
              price: 0,
              homePrice: 0,
              error: item.error || "Invalid item ID",
            };
          }
          const itemId = item.itemId;
          if (!marketData.items || !marketData.items[itemId]) {
            return {
              ...item,
              server: "N/A",
              price: 0,
              homePrice: 0,
              hq: false,
              error: "No market data available",
            };
          }
          const itemData = marketData.items[itemId];
          if (
            !itemData ||
            !itemData.listings ||
            itemData.listings.length === 0
          ) {
            return {
              ...item,
              server: "N/A",
              price: 0,
              homePrice: 0,
              hq: false,
              error: "No market data available",
            };
          }
          const filteredListings = itemData.listings.filter(
            (l) => !!l.hq === isHQ
          );
          if (isHQ && filteredListings.length === 0) {
            const nqListings = itemData.listings.filter((l) => !l.hq);
            if (nqListings.length > 0) {
              let bestNQ = nqListings[0];
              for (const listing of nqListings) {
                if (listing.pricePerUnit < bestNQ.pricePerUnit) {
                  bestNQ = listing;
                }
              }
              return {
                ...item,
                server: bestNQ.worldName,
                price: bestNQ.pricePerUnit,
                homePrice: 0,
                hq: false,
                error: undefined,
                fallbackToNQ: true,
              };
            } else {
              return {
                ...item,
                server: "N/A",
                price: 0,
                homePrice: 0,
                hq: false,
                error: "No HQ or NQ listings available",
              };
            }
          }
          if (!isHQ && filteredListings.length === 0) {
            const hqListings = itemData.listings.filter((l) => !!l.hq);
            if (hqListings.length > 0) {
              let bestHQ = hqListings[0];
              for (const listing of hqListings) {
                if (listing.pricePerUnit < bestHQ.pricePerUnit) {
                  bestHQ = listing;
                }
              }
              return {
                ...item,
                server: bestHQ.worldName,
                price: bestHQ.pricePerUnit,
                homePrice: 0,
                hq: true,
                error: undefined,
                fallbackToHQ: true,
              };
            } else {
              return {
                ...item,
                server: "N/A",
                price: 0,
                homePrice: 0,
                hq: false,
                error: "No NQ or HQ listings available",
              };
            }
          }
          let bestListing = filteredListings[0];
          for (const listing of filteredListings) {
            if (listing.pricePerUnit < bestListing.pricePerUnit) {
              bestListing = listing;
            }
          }
          originalHomeServerPrices[itemId] = 0;
          return {
            ...item,
            server: bestListing.worldName,
            price: bestListing.pricePerUnit,
            homePrice: 0,
            hq: !!bestListing.hq,
            error: undefined,
            fallbackToNQ: false,
          };
        });
      }

      function generateItemRows(items) {
        resultsBody.innerHTML = "";
        items.forEach((item) => {
          const row = document.createElement("tr");
          if (item.error) {
            row.innerHTML = `
            <td colspan="4">
              <div class="item-name">
                <div class="item-icon" style="background: rgba(231, 76, 60, 0.3);">
                  <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div>
                  <div>
                    ${
                      item.hq
                        ? `<img src="https://xivapi.com/img-misc/hq.png" alt="HQ" title="HQ" style="width:16px;height:16px;vertical-align:middle;margin-right:6px;"/>`
                        : ""
                    }
                    ${item.name}
                  </div>
                  <div style="color: #e74c3c; font-size: 0.85rem; margin-top: 5px;">
                    <i class="fas fa-exclamation-circle"></i> ${item.error}
                  </div>
                </div>
              </div>
            </td>
          `;
            resultsBody.appendChild(row);
            return;
          }
          const hqIcon = item.hq
            ? `<img src="https://xivapi.com/img-misc/hq.png" alt="HQ" title="HQ" style="width:16px;height:16px;vertical-align:middle;margin-right:6px;"/>`
            : "";
          const itemIcon = item.icon
            ? `<img src="${item.icon}" alt="" style="width:32px;height:32px;border-radius:6px;object-fit:cover;background:#fff;"/>`
            : `<i class="fas fa-cube"></i>`;
          row.innerHTML = `
          <td>
            <div class="item-name">
              <div class="item-icon">
                ${itemIcon}
              </div>
              <div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  ${hqIcon}${item.name}
                  <button class="btn btn-universalis" data-itemid="${
                    item.itemId
                  }" data-itemname="${encodeURIComponent(
            item.name
          )}" style="margin-left:8px;padding:6px 12px;font-size:0.92rem;background:#222;color:#fff;border-radius:6px;border:none;cursor:pointer;transition:background 0.2s;display:flex;align-items:center;gap:6px;">
                    <i class='fas fa-tags'></i> Price List
                  </button>
                </div>
              </div>
            </div>
          </td>
          <td class="quantity-cell">${item.quantity}</td>
          <td class="server-cell">${item.server}</td>
          <td class="price-cell">${item.price.toLocaleString()} Gil</td>
        `;
          resultsBody.appendChild(row);
        });
        setTimeout(() => {
          document.querySelectorAll(".btn-universalis").forEach((btn) => {
            btn.onclick = async function (e) {
              const itemId = this.getAttribute("data-itemid");
              const itemName = decodeURIComponent(
                this.getAttribute("data-itemname")
              );
              const dc = datacenterSelect.value;
              const url = `https://universalis.app/api/v2/${dc}/${itemId}?listings=20`;
              let modal = document.createElement("div");
              modal.className = "modal-backdrop";
              modal.id = "universalis-modal-backdrop";
              modal.innerHTML = `<div class='modal-box' style='max-width:480px;width:95vw;'>
                <button class='close-btn' id='close-universalis-modal'>&times;</button>
                <h3 style='margin-bottom:12px;'><i class='fas fa-tags'></i> ${itemName} Price List</h3>
                <div id='universalis-modal-content' style='min-height:80px;display:flex;align-items:center;justify-content:center;'><i class='fas fa-spinner fa-spin'></i> Loading...</div>
                <button id='open-universalis-btn' style='margin-top:18px;width:100%;padding:12px 0;background:#6366f1;color:#fff;border:none;border-radius:7px;font-weight:600;font-size:1rem;cursor:pointer;transition:background 0.2s;'><i class='fas fa-external-link-alt'></i> Open In Universalis</button>
              </div>`;
              document.body.appendChild(modal);
              document.getElementById("close-universalis-modal").onclick = () =>
                modal.remove();
              modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
              };
              document.getElementById("open-universalis-btn").onclick = () => {
                window.open(
                  `https://universalis.app/market/${itemId}`,
                  "_blank"
                );
              };
              try {
                const resp = await fetch(url);
                if (!resp.ok) throw new Error("Failed to fetch price list");
                const data = await resp.json();
                let listings = data.listings || [];
                if (!Array.isArray(listings) || listings.length === 0) {
                  document.getElementById(
                    "universalis-modal-content"
                  ).innerHTML = `<div style='color:#e74c3c;text-align:center;'>No price data found.</div>`;
                  return;
                }
                let html = `<div style='max-height:320px;overflow-y:auto;width:100%;'><table style='width:100%;font-size:0.97rem;border-collapse:collapse;'><thead><tr><th style='text-align:left;padding:7px 6px;color:#6366f1;'>Server</th><th style='text-align:right;padding:7px 6px;color:#6366f1;'>Price</th><th style='text-align:center;padding:7px 6px;color:#6366f1;'>Qty</th><th style='text-align:center;padding:7px 6px;color:#6366f1;'>HQ</th></tr></thead><tbody>`;
                listings.forEach((l) => {
                  html += `<tr><td style='padding:7px 6px;'>${
                    l.worldName
                  }</td><td style='padding:7px 6px;text-align:right;'>${l.pricePerUnit.toLocaleString()} Gil</td><td style='padding:7px 6px;text-align:center;'>${
                    l.quantity
                  }</td><td style='padding:7px 6px;text-align:center;'>${
                    l.hq
                      ? "<span style='color:#6366f1;font-weight:600;'>HQ</span>"
                      : "NQ"
                  }</td></tr>`;
                });
                html += `</tbody></table></div>`;
                document.getElementById("universalis-modal-content").innerHTML =
                  html;
              } catch (err) {
                document.getElementById(
                  "universalis-modal-content"
                ).innerHTML = `<div style='color:#e74c3c;text-align:center;'>Failed to load price data.</div>`;
              }
            };
          });
        }, 0);
      }

      function generateOptimalPath(items) {
        pathSteps.innerHTML = "";
        const itemsByServer = {};
        let totalCostValue = 0;
        let homeServerCost = 0;
        items.forEach((item) => {
          if (item.server === "N/A" || item.error) return;
          if (!itemsByServer[item.server]) {
            itemsByServer[item.server] = [];
          }
          itemsByServer[item.server].push(item);
          totalCostValue += item.price * item.quantity;
          if (originalHomeServerPrices[item.itemId]) {
            homeServerCost +=
              originalHomeServerPrices[item.itemId] * item.quantity;
          }
        });
        let stepCount = 1;
        const serverList = Object.keys(itemsByServer);
        serverList.forEach((server) => {
          const step = document.createElement("div");
          step.className = "path-step";
          const serverItems = itemsByServer[server];
          const serverCost = serverItems.reduce(
            (sum, item) => sum + item.price * item.quantity,
            0
          );
          const iconsHtml = serverItems
            .map((item, idx) => {
              const iconUrl = item.icon
                ? `<img src="${item.icon}" alt="" style="width:32px;height:32px;border-radius:6px;object-fit:cover;background:#fff;"/>`
                : `<i class=\"fas fa-cube\"></i>`;
              return `
              <div class="route-item-icon" data-item-name="${item.name.replace(
                /"/g,
                "&quot;"
              )}" data-idx="${stepCount}_${idx}" tabindex="0">
                ${iconUrl}
                <span class="route-tooltip">${item.quantity}x ${
                item.name
              }</span>
              </div>
            `;
            })
            .join("");
          step.innerHTML = `
          <div class="step-number">${stepCount}</div>
          <div class="step-content">
            <div>Travel to <span class="step-server">${server}</span></div>
            <div class="route-items-row">${iconsHtml}</div>
          </div>
          <div class="step-price">${serverCost.toLocaleString()} Gil</div>
        `;
          pathSteps.appendChild(step);
          stepCount++;
        });
        setTimeout(() => {
          document.querySelectorAll(".route-item-icon").forEach((icon) => {
            icon.addEventListener("click", async function (e) {
              const name = this.getAttribute("data-item-name");
              try {
                await navigator.clipboard.writeText(name);
                const tooltip = this.querySelector(".route-tooltip");
                const original = tooltip.textContent;
                tooltip.innerHTML = "Copied to Clipboard";
                tooltip.classList.add("copied");
                setTimeout(() => {
                  tooltip.textContent = original;
                  tooltip.classList.remove("copied");
                }, 1200);
              } catch (err) {}
            });
          });
        }, 0);
        const savings = homeServerCost - totalCostValue;
        const savingsText =
          savings > 0
            ? `Estimated Savings: ${savings.toLocaleString()} Gil`
            : "No savings estimated (home server prices unavailable)";
        totalCost.textContent = `Total Estimated Cost: ${totalCostValue.toLocaleString()} Gil`;
        totalSavings.textContent = savingsText;
        totalSavings.style.display = savings > 0 ? "flex" : "none";
        pathSection.style.display = "block";
        var pathBtnGroup = document.getElementById("path-btn-group");
        if (pathBtnGroup) pathBtnGroup.style.display = "none";
      }

      function showError(message) {
        errorSection.style.display = "block";
        errorSection.innerHTML = `
        <h3><i class="fas fa-exclamation-triangle"></i> Error</h3>
        <p>${message}</p>
      `;
        errorSection.classList.add("message-section");
      }

      function showSuccess(message) {
        successSection.style.display = "block";
        successSection.innerHTML = `
        <h3><i class="fas fa-check-circle"></i> Success</h3>
        <p>${message}</p>
      `;
        successSection.classList.add("message-section");
      }

      function hideMessages() {
        errorSection.style.display = "none";
        successSection.style.display = "none";
      }

      const modeToggleBtn = document.getElementById("mode-toggle");

      function setMode(mode) {
        document.body.classList.remove("dark-mode", "light-mode");
        document.body.classList.add(mode + "-mode");
        localStorage.setItem("ryutsu-mode", mode);

        if (mode === "dark") {
          modeToggleBtn.innerHTML = '<i class="fas fa-sun"></i>';
        } else {
          modeToggleBtn.innerHTML = '<i class="fas fa-moon"></i>';
        }
      }

      let savedMode = localStorage.getItem("ryutsu-mode");
      if (!savedMode) savedMode = "light";
      setMode(savedMode);

      modeToggleBtn.addEventListener("click", () => {
        const current = document.body.classList.contains("dark-mode")
          ? "dark"
          : "light";
        const newMode = current === "dark" ? "light" : "dark";
        setMode(newMode);
      });

      searchBtn.addEventListener("click", async function () {
        var pathBtnGroup = document.getElementById("path-btn-group");
        if (pathBtnGroup) pathBtnGroup.style.display = "flex";
        const itemsText = itemsInput.value;
        const dc = datacenterSelect.value;
        if (!itemsText) {
          showError("Please enter your items list");
          return;
        }
        if (!dc) {
          showError("Please select a data center");
          return;
        }
        searchBtn.disabled = true;
        searchBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Searching...';
        pathBtn.disabled = true;
        resultsInfo.textContent = "Parsing items...";
        resultsBody.innerHTML = "";
        pathSection.style.display = "none";
        hideMessages();
        try {
          const parsedItems = parseItems(itemsText);
          if (parsedItems.length === 0) {
            throw new Error("No valid items found. Please check your format.");
          }
          resultsInfo.textContent = `Found ${parsedItems.length} items. Fetching item IDs...`;
          const itemsWithIds = [];
          for (const item of parsedItems) {
            const {
              id: itemId,
              icon,
              canonicalName,
            } = await fetchItemIdAndIconFromXIVAPI(item.name);
            if (itemId) {
              itemsWithIds.push({ ...item, name: canonicalName, itemId, icon });
            } else {
              itemsWithIds.push({
                ...item,
                name: canonicalName,
                itemId: null,
                icon: null,
                error: "Item not found in XIVAPI",
              });
            }
          }
          const validItems = itemsWithIds.filter(
            (item) => item.itemId && !item.error
          ).length;
          resultsInfo.textContent = `Fetched IDs for ${validItems} items. Getting market data...`;
          if (validItems < itemsWithIds.length) {
            resultsInfo.textContent += ` (${
              itemsWithIds.length - validItems
            } items had issues)`;
          }
          const marketData = await fetchMarketData(dc, itemsWithIds);
          showSuccess(`Fetched real-time market data from ${dc} data center`);
          shoppingList = findBestServers(marketData, itemsWithIds, null);
          const validMarketItems = shoppingList.filter(
            (item) => !item.error
          ).length;
          resultsInfo.textContent = `${validMarketItems} items with prices found on ${dc} Data Center`;
          if (validMarketItems < shoppingList.length) {
            resultsInfo.textContent += ` (${
              shoppingList.length - validMarketItems
            } items had issues)`;
          }
          generateItemRows(shoppingList);
          pathBtn.disabled = false;
        } catch (error) {
          console.error("Error:", error);
          resultsInfo.textContent = "Error processing data. See details below.";
          showError(
            error.message || "An unexpected error occurred. Please try again."
          );
        } finally {
          searchBtn.disabled = false;
          searchBtn.innerHTML = '<i class="fas fa-search"></i> Search Prices';
        }
      });

      pathBtn.addEventListener("click", function () {
        if (shoppingList.length === 0) {
          showError("No shopping list data available");
          return;
        }
        this.disabled = true;
        this.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Calculating...';
        hideMessages();
        setTimeout(() => {
          generateOptimalPath(shoppingList);
          this.disabled = false;
          this.innerHTML = '<i class="fas fa-route"></i> Find Path';
        }, 500);
      });

      document.addEventListener("DOMContentLoaded", () => {
        itemsInput.value = "";
        document.getElementById("help-btn").onclick = showHelpModal;
      });
    </script>
  </body>
</html>
